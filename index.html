<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning and Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 800px;
        }
        .chat-message.user {
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.ai {
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
            align-self: flex-start;
        }
        
        .shadow-3d {
            box-shadow: 
                0 4px 6px rgba(0, 0, 0, 0.1), 
                0 1px 3px rgba(0, 0, 0, 0.08), 
                0 10px 20px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 text-gray-800 bg-gray-50 transition-colors duration-500">

    <div class="container mx-auto bg-white rounded-3xl shadow-3d p-6 sm:p-10 transition-all duration-500">
        <div class="flex justify-center items-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-blue-800 drop-shadow-sm">AI Learning & Quiz</h1>
        </div>
        <p class="text-center text-gray-600 mb-10 text-lg">Ready to learn something new? Type a topic and get started!</p>

        <!-- Home Page Section -->
        <div id="homePage" class="transition-opacity duration-700 flex flex-col items-stretch">
            <div class="flex flex-col sm:flex-row gap-6 mb-8">
                <textarea id="topicInput" rows="3" placeholder="e.g., The water cycle, Ancient Greek history, Simple machine principles..."
                          class="flex-grow p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-400 transition-all duration-300 resize-none text-lg"></textarea>
                <div class="flex flex-col gap-4 w-full sm:w-1/3">
                    <input type="number" id="questionCountInput" value="10" min="1" max="20" placeholder="Number of questions" class="p-4 border-2 border-gray-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-400 transition-all duration-300 text-center text-lg w-full">
                    <button id="generateButton"
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-8 rounded-2xl shadow-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-400 disabled:from-gray-400 disabled:to-gray-500 disabled:shadow-none disabled:transform-none">
                        Generate Quiz
                    </button>
                </div>
            </div>
            
            <div id="loadingIndicator" class="hidden text-center mt-8">
                <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-blue-600" role="status">
                    <span class="!absolute !-m-px !h-px !-w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
                </div>
                <p class="mt-4 text-gray-500 text-lg">Generating your content...</p>
            </div>
    
            <div id="errorContainer" class="hidden mt-8 bg-red-100 p-6 rounded-2xl text-red-700 border border-red-300 shadow-md transition-opacity duration-300">
                <p id="errorMessage" class="font-semibold"></p>
            </div>
        </div>

        <!-- Learning & Quiz Page Section -->
        <div id="learningAndQuizPage" class="hidden transition-opacity duration-700">
            <button id="backButton" class="mb-6 text-blue-600 hover:text-blue-800 font-semibold transition-all duration-300 transform hover:-translate-x-1">
                &larr; Back to Home
            </button>
            
            <div id="resultContainer" class="mt-4">
                <!-- Learning Content Section -->
                <div id="learningSection" class="transition-all duration-500">
                    <div id="learningContent" class="bg-blue-50 p-8 rounded-3xl border border-blue-200 mb-8 shadow-inner text-lg">
                        <!-- Learning content will be displayed here -->
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mb-8">
                        <button id="getMoreInfoButton" class="flex-grow bg-blue-500 text-white font-semibold py-4 rounded-2xl shadow-md hover:bg-blue-600 transition-colors duration-300 disabled:bg-gray-400">
                            Explain it more simply
                        </button>
                        <button id="getExamplesButton" class="flex-grow bg-blue-500 text-white font-semibold py-4 rounded-2xl shadow-md hover:bg-blue-600 transition-colors duration-300 disabled:bg-gray-400">
                            Give me examples
                        </button>
                        <button id="speakButton" class="flex-grow bg-purple-500 text-white font-semibold py-4 rounded-2xl shadow-md hover:bg-purple-600 transition-colors duration-300 disabled:bg-gray-400">
                            ✨ Speak Content
                        </button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                         <button id="startQuizButton" class="flex-grow bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400">
                            Start Quiz
                        </button>
                    </div>
                    
                    <!-- Chat Section -->
                    <div id="chatSection" class="mt-12 bg-gray-50 p-8 rounded-3xl border border-gray-200 shadow-inner">
                        <h3 class="text-2xl font-bold mb-6 text-center text-blue-800">Ask the AI Tutor</h3>
                        <div id="chatMessages" class="flex flex-col gap-4 overflow-y-auto max-h-72 mb-4 p-2">
                            <!-- Chat messages will appear here -->
                        </div>
                        <form id="chatForm" class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="chatInput" placeholder="Ask a question..."
                                class="flex-grow p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            <button type="submit" id="chatSendButton" class="bg-blue-600 text-white py-3 px-6 rounded-xl shadow-md hover:bg-blue-700 transition-colors disabled:bg-gray-400">
                                Send ✨
                            </button>
                            <button type="button" id="clearChatButton" class="bg-red-500 text-white py-3 px-6 rounded-xl shadow-md hover:bg-red-600 transition-colors">
                                Clear
                            </button>
                        </form>
                    </div>
                </div>
    
                <!-- Quiz Section (initially hidden) -->
                <div id="quizSection" class="hidden transition-all duration-500">
                    <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold mb-2 sm:mb-0 text-blue-800">Quiz Time!</h2>
                        <div id="timerDisplay" class="text-xl font-semibold text-red-600 bg-red-100 px-6 py-2 rounded-full border-2 border-red-300 shadow-sm w-full sm:w-auto text-center sm:text-right">
                            2:00
                        </div>
                    </div>
                    <div id="quizContent" class="space-y-6">
                        <!-- Quiz questions will be displayed here -->
                    </div>
                    <button id="nextButton" class="hidden w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-1 hover:scale-105 mt-8">
                        Next Question &rarr;
                    </button>
                    <div id="quizScore" class="hidden mt-8 p-6 rounded-2xl text-center font-bold text-2xl shadow-md"></div>
                    <div id="quizEndButtons" class="hidden flex flex-col sm:flex-row justify-center gap-4 mt-8">
                        <button id="showAnswersButton" class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-2xl shadow-md hover:bg-blue-600 transition-colors">
                            Show Correct Answers
                        </button>
                        <button id="quizBackButton" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-2xl shadow-md hover:bg-gray-400 transition-colors">
                            Back to Home
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="messageBox" class="fixed inset-x-0 bottom-8 w-fit mx-auto text-white text-center py-4 px-8 rounded-full shadow-lg transform transition-all duration-500 -translate-y-2 opacity-0 pointer-events-none text-lg">
            <!-- Message box for user feedback -->
        </div>
    </div>

    <script>
        const topicInput = document.getElementById('topicInput');
        const questionCountInput = document.getElementById('questionCountInput');
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const homePage = document.getElementById('homePage');
        const learningAndQuizPage = document.getElementById('learningAndQuizPage');
        const resultContainer = document.getElementById('resultContainer');
        const learningContent = document.getElementById('learningContent');
        const startQuizButton = document.getElementById('startQuizButton');
        const getMoreInfoButton = document.getElementById('getMoreInfoButton');
        const getExamplesButton = document.getElementById('getExamplesButton');
        const backButton = document.getElementById('backButton');
        const quizBackButton = document.getElementById('quizBackButton');
        const learningSection = document.getElementById('learningSection');
        const quizSection = document.getElementById('quizSection');
        const quizContent = document.getElementById('quizContent');
        const quizScore = document.getElementById('quizScore');
        const quizEndButtons = document.getElementById('quizEndButtons');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const messageBox = document.getElementById('messageBox');
        const timerDisplay = document.getElementById('timerDisplay');
        const showAnswersButton = document.getElementById('showAnswersButton');
        const nextButton = document.getElementById('nextButton');
        const speakButton = document.getElementById('speakButton');
        const chatSection = document.getElementById('chatSection');
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatSendButton = document.getElementById('chatSendButton');
        const clearChatButton = document.getElementById('clearChatButton');
        
        const apiKey = "AIzaSyD0iha7rSHd6RGsNTyg_8uhfSuJ3pocU3s";
        const textToTextApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        
        let timerInterval;
        let timeLeft;
        let loadedQuizData = null;
        let score = 0;
        let currentQuestionIndex = 0;
        let audioContext;
        let chatHistory = [];
        

        // Function to handle retries with exponential backoff for API calls
        async function retryWithExponentialBackoff(callback, args, maxRetries = 5, delay = 1000) {
            if (!apiKey || apiKey === "AIzaSyD0iha7rSHd6RGsNTyg_8uhfSuJ3pocU3s") {
                const errorMsg = "API Key is missing or invalid. Please add your key to the 'apiKey' variable in the code.";
                console.error(errorMsg);
                throw new Error(errorMsg);
            }
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await callback(...args);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 503 && i < maxRetries - 1) {
                        console.log(`API call failed with 503, retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponentially increase delay
                    } else {
                        throw new Error(`API returned an error: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    if (i < maxRetries - 1) {
                        console.error(`Attempt ${i + 1} failed, retrying...`, error);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Function to manage page visibility
        function showPage(page) {
            homePage.classList.add('hidden');
            learningAndQuizPage.classList.add('hidden');
            if (page === 'homePage') {
                homePage.classList.remove('hidden');
            } else if (page === 'learningAndQuizPage') {
                learningAndQuizPage.classList.remove('hidden');
            }
        }

        // Function to show a temporary message to the user
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e'; // red-500 or green-500
            messageBox.classList.remove('opacity-0', '-translate-y-2');
            messageBox.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', '-translate-y-2');
            }, 3000);
        }

        // Function to handle the quiz answer selection
        function checkAnswer(questionIndex, selectedOption) {
            const questionElement = document.getElementById(`question-${questionIndex}`);
            const options = questionElement.querySelectorAll('.quiz-option');
            const data = JSON.parse(questionElement.dataset.question);
            const correctAnswer = data.correctAnswer;
            const explanation = data.correctAnswerExplanation;
            
            // Check if a selection has already been made
            if (questionElement.dataset.answered) {
                return;
            }
            questionElement.dataset.answered = 'true';
            
            // Stop the timer for this question
            clearInterval(timerInterval);

            options.forEach(option => {
                option.disabled = true;
                if (option.textContent === correctAnswer) {
                    option.classList.remove('hover:bg-gray-200', 'border-gray-300', 'text-gray-700');
                    option.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'font-bold');
                } else if (option.textContent === selectedOption) {
                    option.classList.remove('hover:bg-gray-200', 'border-gray-300');
                    option.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                }
            });

            if (selectedOption === correctAnswer) {
                score++;
                showMessage("Correct! Great job!");
            } else {
                showMessage("Incorrect. The correct answer is highlighted.", true);
            }

            // Display the explanation
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'mt-4 p-4 rounded-lg border-l-4 border-blue-500 bg-blue-50';
            explanationDiv.innerHTML = `<p class="font-bold text-blue-800">Explanation:</p><p class="mt-1 text-gray-700">${explanation}</p>`;
            questionElement.appendChild(explanationDiv);

            // Change button text for the final question
            if (currentQuestionIndex === loadedQuizData.quiz.length - 1) {
                nextButton.textContent = 'Check Result';
            } else {
                nextButton.textContent = 'Next Question →';
            }
            
            nextButton.classList.remove('hidden');
        }
        
        // Function to advance to the next question
        function nextQuestion() {
            currentQuestionIndex++;
            nextButton.classList.add('hidden'); // Hide the button immediately
            if (currentQuestionIndex < loadedQuizData.quiz.length) {
                renderQuestion(currentQuestionIndex);
            } else {
                endQuiz();
            }
        }
        
        // Function to start the timer for the current question
        function startQuestionTimer() {
            timeLeft = 120; // 2 minutes per question
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    const questionElement = document.getElementById(`question-${currentQuestionIndex}`);
                    if (questionElement) {
                         const options = questionElement.querySelectorAll('.quiz-option');
                         options.forEach(option => option.disabled = true);
                         questionElement.dataset.answered = 'true';
                         showMessage("Time's up for this question!", true);
                         nextButton.classList.remove('hidden');
                    }
                }
            }, 1000);
        }

        // Function to update the timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // Function to end the quiz when time runs out or all questions are answered
        function endQuiz() {
            clearInterval(timerInterval);
            timerDisplay.textContent = "Quiz Finished!";
            
            const totalQuestions = loadedQuizData.quiz.length;
            quizContent.innerHTML = '';
            quizScore.textContent = `You scored ${score} out of ${totalQuestions}!`;
            quizScore.className = `mt-6 p-4 rounded-lg text-center font-bold text-2xl shadow-md ${score >= totalQuestions / 2 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            quizScore.classList.remove('hidden');
            quizEndButtons.classList.remove('hidden');
            showAnswersButton.classList.remove('hidden');
        }
        
        // Function to show correct answers
        function showCorrectAnswers() {
            quizContent.innerHTML = ''; // Clear previous quiz content
            showAnswersButton.classList.add('hidden'); // Hide the button
            nextButton.classList.add('hidden');

            loadedQuizData.quiz.forEach((question, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200';
                
                let optionsHtml = '';
                question.options.forEach(option => {
                    const isCorrect = option === question.correctAnswer;
                    const optionClasses = isCorrect
                        ? 'bg-green-100 border-green-500 text-green-800 font-bold'
                        : 'bg-gray-100 border-gray-300 text-gray-700';

                    optionsHtml += `
                        <button class="w-full text-left p-3 border rounded-lg cursor-default ${optionClasses}" disabled>
                            ${option}
                        </button>
                    `;
                });

                // Add the explanation block below the question
                const explanationBlock = `
                    <div class="mt-4 p-4 rounded-lg border-l-4 border-blue-500 bg-blue-50">
                        <p class="font-bold text-blue-800">Correct Answer:</p>
                        <p class="text-gray-700">${question.correctAnswer}</p>
                        <p class="font-bold text-blue-800 mt-2">Explanation:</p>
                        <p class="text-gray-700">${question.correctAnswerExplanation}</p>
                    </div>
                `;

                qDiv.innerHTML = `
                    <p class="text-lg font-medium mb-4">${index + 1}. ${question.question}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${optionsHtml}
                    </div>
                    ${explanationBlock}
                `;
                quizContent.appendChild(qDiv);
            });
        }


        // Function to render the learning content
        function renderLearningContent(data) {
            learningContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Learning Summary</h2><p class="text-gray-700">${data.explanation}</p>`;
            startQuizButton.disabled = false;
        }

        // Function to handle the API call for both content and quiz
        async function generateQuiz() {
            const topic = topicInput.value.trim();
            const questionCount = parseInt(questionCountInput.value, 10);

            if (topic.length === 0) {
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = "Please enter a topic to generate a quiz.";
                return;
            }

            if (isNaN(questionCount) || questionCount <= 0) {
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = "Please enter a valid number of questions (1 or more).";
                return;
            }

            // Clear any previous timer and state
            clearInterval(timerInterval);
            loadedQuizData = null;
            chatHistory = [];
            chatMessages.innerHTML = '';
            
            // Reset UI
            errorContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;

            // Prompt updated to be student-friendly
            const prompt = `Based on the topic "${topic}", provide a detailed explanation and a multiple-choice quiz. The explanation should be a single paragraph using simple language suitable for a middle school student. The quiz must have exactly ${questionCount} questions, with each question having 4 options. The response MUST be a single JSON object with the following structure:
            
            {
                "explanation": "Your detailed explanation of the topic here.",
                "quiz": [
                    {
                        "question": "Question 1 text here?",
                        "options": ["Option A", "Option B", "Option C", "Option D"],
                        "correctAnswer": "Correct option text here",
                        "correctAnswerExplanation": "A short, one-sentence explanation for the correct answer, written in simple terms for a student."
                    }
                ]
            }
            
            Do not include any other text or formatting. The response must be a valid JSON object.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "explanation": { "type": "STRING" },
                            "quiz": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "question": { "type": "STRING" },
                                        "options": {
                                            "type": "ARRAY",
                                            "items": { "type": "STRING" }
                                        },
                                        "correctAnswer": { "type": "STRING" },
                                        "correctAnswerExplanation": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["question", "options", "correctAnswer", "correctAnswerExplanation"]
                                }
                            }
                        },
                        "propertyOrdering": ["explanation", "quiz"]
                    }
                }
            };
            
            try {
                const response = await retryWithExponentialBackoff(fetch, [textToTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }]);
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(jsonString);
                    loadedQuizData = parsedData;
                    renderLearningContent(loadedQuizData);
                    showPage('learningAndQuizPage');
                } else {
                    throw new Error("Invalid or empty response from the AI.");
                }

            } catch (error) {
                console.error("API call failed:", error);
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = `An error occurred: ${error.message}. Please try again. If the issue persists, ensure your API key is valid.`;
            } finally {
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
            }
        }
        
        // Function to fetch more detailed explanation
        async function getMoreInfo() {
            const topic = topicInput.value.trim();
            if (topic.length === 0) {
                return;
            }

            loadingIndicator.classList.remove('hidden');
            getMoreInfoButton.disabled = true;
            getExamplesButton.disabled = true;
            startQuizButton.disabled = true;

            const prompt = `Provide a significantly more detailed and in-depth explanation of the topic "${topic}". Use vocabulary and sentence structure appropriate for a middle school student. The response should be a single paragraph of text only.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            try {
                const response = await retryWithExponentialBackoff(fetch, [textToTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }]);
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const newExplanation = result.candidates[0].content.parts[0].text;
                    learningContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Detailed Explanation</h2><p class="text-gray-700">${newExplanation}</p>`;
                    showMessage("Explanation updated!", false);
                } else {
                    throw new Error("Invalid or empty response from the AI.");
                }
            } catch (error) {
                console.error("API call failed:", error);
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = `An error occurred: ${error.message}. Please try again.`;
            } finally {
                loadingIndicator.classList.add('hidden');
                getMoreInfoButton.disabled = false;
                getExamplesButton.disabled = false;
                startQuizButton.disabled = false;
            }
        }

        // Function to get examples for the topic
        async function getExamples() {
            const topic = topicInput.value.trim();
            if (topic.length === 0) {
                return;
            }

            loadingIndicator.classList.remove('hidden');
            getMoreInfoButton.disabled = true;
            getExamplesButton.disabled = true;
            startQuizButton.disabled = true;

            const prompt = `Provide three to five simple, real-world examples to help a student understand "${topic}". Use simple language and present them as a single, clear paragraph.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const response = await retryWithExponentialBackoff(fetch, [textToTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }]);

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const examples = result.candidates[0].content.parts[0].text;
                    learningContent.innerHTML = `<h2 class="text-2xl font-bold mb-4">Examples</h2><p class="text-gray-700">${examples}</p>`;
                    showMessage("Examples loaded!", false);
                } else {
                    throw new Error("Invalid or empty response from the AI.");
                }
            } catch (error) {
                console.error("API call failed:", error);
                errorContainer.classList.remove('hidden');
                errorMessage.textContent = `An error occurred: ${error.message}. Please try again.`;
            } finally {
                loadingIndicator.classList.add('hidden');
                getMoreInfoButton.disabled = false;
                getExamplesButton.disabled = false;
                startQuizButton.disabled = false;
            }
        }

        // Function to handle the chat input
        async function handleChat(event) {
            event.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Display user message
            appendMessage(userMessage, 'user');
            chatInput.value = '';
            chatSendButton.disabled = true;

            // Build payload with context and chat history
            const prompt = `You are a helpful and patient tutor for a middle school student. The current topic of study is "${topicInput.value.trim()}". Answer the student's question concisely and in a way that is easy to understand.`;

            chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: prompt }] },
            };

            try {
                const response = await retryWithExponentialBackoff(fetch, [textToTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }]);

                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText) {
                    appendMessage(aiResponseText, 'ai');
                    chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                } else {
                    appendMessage("Sorry, I couldn't get a response. Please try again.", 'ai');
                }
            } catch (error) {
                console.error("Chat API call failed:", error);
                appendMessage("Sorry, there was an error communicating with the AI. Please try again. If the issue persists, ensure your API key is valid.", 'ai');
            } finally {
                chatSendButton.disabled = false;
            }
        }

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message p-3 rounded-lg max-w-[85%]`;
            messageDiv.classList.add(sender);
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the bottom
        }

        function clearChat() {
            chatHistory = [];
            chatMessages.innerHTML = '';
            showMessage("Chat cleared!");
        }

        // Function to render a single quiz question
        function renderQuestion(index) {
            if (index >= loadedQuizData.quiz.length) {
                endQuiz();
                return;
            }
            const question = loadedQuizData.quiz[index];
            quizContent.innerHTML = '';
            
            const qDiv = document.createElement('div');
            qDiv.id = `question-${index}`;
            qDiv.dataset.question = JSON.stringify(question);
            qDiv.className = 'bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200';
            
            let optionsHtml = '';
            question.options.forEach(option => {
                optionsHtml += `
                    <button class="quiz-option w-full text-left p-4 border-2 border-gray-300 rounded-xl transition-all duration-200 hover:bg-gray-200 hover:shadow-md text-gray-700 font-medium" 
                            onclick="checkAnswer(${index}, '${option}')">
                        ${option}
                    </button>
                `;
            });

            qDiv.innerHTML = `
                <p class="text-xl font-medium mb-5">${index + 1}. ${question.question}</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${optionsHtml}
                </div>
            `;
            quizContent.appendChild(qDiv);
            startQuestionTimer();
        }
        
        // Function to start the quiz
        function startQuiz() {
            if (!loadedQuizData) return;
            
            learningSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0; // Reset score
            renderQuestion(currentQuestionIndex);
        }

        // Function to play text from the content area
        async function speakContent() {
            const textToSpeak = learningContent.textContent;
            if (textToSpeak.length === 0) {
                showMessage("There is no content to speak.", true);
                return;
            }
            
            speakButton.disabled = true;
            speakButton.textContent = "Loading Audio...";

            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            try {
                const response = await retryWithExponentialBackoff(fetch, [ttsApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }]);
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        speakButton.disabled = false;
                        speakButton.textContent = "✨ Speak Content";
                    };
                } else {
                    throw new Error("Invalid audio response from API.");
                }
            } catch (error) {
                console.error("TTS API call failed:", error);
                showMessage("Failed to generate speech. Please try again. If the issue persists, ensure your API key is valid.", true);
                speakButton.disabled = false;
                speakButton.textContent = "✨ Speak Content";
            }
        }

        // Helper function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM to WAV format
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');

            // fmt sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true);

            // data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write PCM data
            const pcmView = new Int16Array(buffer, 44, pcmData.length);
            for (let i = 0; i < pcmData.length; i++) {
                pcmView[i] = pcmData[i];
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Function to reset all data and UI state
        function resetApp() {
            // Reset input fields
            topicInput.value = '';
            questionCountInput.value = '10';

            // Reset UI states
            errorContainer.classList.add('hidden');
            learningContent.innerHTML = '';
            quizContent.innerHTML = '';
            quizScore.classList.add('hidden');
            quizEndButtons.classList.add('hidden');
            learningSection.classList.remove('hidden');
            quizSection.classList.add('hidden');
            nextButton.classList.add('hidden');
            nextButton.textContent = 'Next Question →'; // Reset the button text

            // Reset data variables
            loadedQuizData = null;
            score = 0;
            currentQuestionIndex = 0;
            chatHistory = [];
            chatMessages.innerHTML = '';

            // Clear any running timers
            clearInterval(timerInterval);
        }
        
        generateButton.addEventListener('click', generateQuiz);
        startQuizButton.addEventListener('click', startQuiz);
        getMoreInfoButton.addEventListener('click', getMoreInfo);
        getExamplesButton.addEventListener('click', getExamples);
        
        // Updated listeners to reset the app data
        backButton.addEventListener('click', () => {
            resetApp();
            showPage('homePage');
        });
        
        quizBackButton.addEventListener('click', () => {
            resetApp();
            showPage('homePage');
        });
        
        showAnswersButton.addEventListener('click', showCorrectAnswers);
        nextButton.addEventListener('click', nextQuestion);
        speakButton.addEventListener('click', speakContent);
        chatForm.addEventListener('submit', handleChat);
        clearChatButton.addEventListener('click', clearChat);
    </script>
</body>
</html>
